# Storage Structure & Upload Paths

This document maps all file uploads in the system to their storage locations.

## Directory Structure

```
storage/app/public/
├── albums/              # Album cover images
│   └── zips/           # Downloadable album ZIP files
├── committees/          # Committee member photos
├── events/              # Event cover images
├── member-photos/       # Member profile photos
├── members/             # Legacy member photos (deprecated)
├── resources/           # Utility Folder documents/files
├── songs/               # Song files
│   ├── audio/          # Audio files (.mp3, .wav)
│   └── sheets/         # Sheet music PDFs
├── stories/
│   └── featured-images/ # Story featured images
├── story-images/        # Story inline images (uploaded via editor)
└── uploads/             # Generic uploads (from editors)
```

## Upload Mappings by Feature

### 1. Member Registration & Profile Photos

**Controller:** `MemberController`, `RegistrationController`, `Admin\MemberController`

**Storage Path:** `storage/app/public/member-photos/`

**Filename Format:**

-   Registration: `{member_id}_{timestamp}.{ext}` (e.g., `GF2025155_1760641165.jpg`)
-   Admin create: `{timestamp}_{original_name}` (e.g., `1760641165_photo.jpg`)

**Code:**

```php
$photo->storeAs('public/member-photos', $photoName);
```

**Public URL:** `/storage/member-photos/{filename}`

---

### 2. Committees

**Controller:** `Admin\CommitteeController`

**Storage Path:** `storage/app/public/committees/`

**Filename Format:** Auto-generated by Laravel

**Code:**

```php
$validated['photo'] = $request->file('photo')->store('committees', 'public');
```

**Public URL:** `/storage/committees/{filename}`

---

### 3. Events

**Controller:** `Admin\EventController`

**Storage Path:** `storage/app/public/events/`

**Filename Format:** Auto-generated by Laravel

**Code:**

```php
$validated['cover_image'] = $request->file('cover_image')->store('events', 'public');
```

**Public URL:** `/storage/events/{filename}`

---

### 4. Stories

**Controller:** `Admin\StoryController`

**Storage Path:** `storage/app/public/stories/featured-images/`

**Filename Format:** Auto-generated by Laravel

**Code:**

```php
$validated['featured_image'] = $request->file('featured_image')
    ->store('stories/featured-images', 'public');
```

**Public URL:** `/storage/stories/featured-images/{filename}`

---

### 5. Story Images (Inline Editor Uploads)

**Controller:** `StoryImageController`

**Storage Path:** `storage/app/public/story-images/`

**Filename Format:** `{timestamp}_{sanitized_name}`

**Code:**

```php
$path = $image->storeAs('story-images', $filename, 'public');
```

**Public URL:** `/storage/story-images/{filename}`

---

### 6. Resources (Utility Folder)

**Controller:** `Admin\ResourceController`

**Storage Path:** `storage/app/public/resources/`

**Filename Format:** `{timestamp}_{slug}.{ext}`

**Code:**

```php
$filePath = $file->storeAs('resources', $fileName, 'public');
```

**Public URL:** `/storage/resources/{filename}`

---

### 7. Albums

**Controller:** `Admin\AlbumController`

**Storage Paths:**

-   Cover images: `storage/app/public/albums/`
-   ZIP downloads: `storage/app/public/albums/zips/`

**Filename Format:** Auto-generated by Laravel

**Code:**

```php
// Cover image
$path = $request->file('cover_image')->store('albums', 'public');

// ZIP file
$zipPath = $request->file('zip_file')->store('albums/zips', 'public');
```

**Public URLs:**

-   `/storage/albums/{filename}`
-   `/storage/albums/zips/{filename}`

---

### 8. Songs

**Controller:** `Admin\SongController`

**Storage Paths:**

-   Audio files: `storage/app/public/songs/audio/`
-   Sheet music: `storage/app/public/songs/sheets/`

**Filename Format:** `{timestamp}_{original_name}`

**Code:**

```php
// Audio file
$data['audio_file'] = $audioFile->storeAs('public/songs/audio', $audioName);

// Sheet music
$data['sheet_music'] = $sheetFile->storeAs('public/songs/sheets', $sheetName);
```

**Public URLs:**

-   `/storage/songs/audio/{filename}`
-   `/storage/songs/sheets/{filename}`

---

### 9. Generic Uploads (Rich Text Editors)

**Controller:** `Admin\UploadController`

**Storage Path:** `storage/app/public/uploads/`

**Filename Format:** Auto-generated by Laravel

**Code:**

```php
$path = $file->store('uploads', 'public');
```

**Public URL:** `/storage/uploads/{filename}`

---

## Storage Configuration

### Filesystem Disk: `public`

Defined in `config/filesystems.php`:

```php
'public' => [
    'driver' => 'local',
    'root' => storage_path('app/public'),
    'url' => env('APP_URL').'/storage',
    'visibility' => 'public',
],
```

### Symlink Requirement

All files stored in `storage/app/public/` must be accessible via `public/storage/` symlink.

**Create symlink:**

```bash
# Via shell (recommended when PHP symlink is disabled)
cd /home/u736264619/public_html/public
ln -s ../storage/app/public storage

# Or via Artisan (if symlink function is enabled)
php artisan storage:link
```

**Verify symlink:**

```bash
ls -la public/storage
# Should show: storage -> ../storage/app/public
```

---

## Migration Checklist for Production

When deploying to production, ensure these folders exist:

```bash
cd /home/u736264619/public_html

# Create all necessary folders
mkdir -p storage/app/public/albums/zips
mkdir -p storage/app/public/committees
mkdir -p storage/app/public/events
mkdir -p storage/app/public/member-photos
mkdir -p storage/app/public/resources
mkdir -p storage/app/public/songs/audio
mkdir -p storage/app/public/songs/sheets
mkdir -p storage/app/public/stories/featured-images
mkdir -p storage/app/public/story-images
mkdir -p storage/app/public/uploads

# Set permissions
chmod -R 775 storage/app/public
chown -R u736264619:u736264619 storage/app/public

# Create symlink in public directory
cd public
rm -f storage  # Remove if exists
ln -s ../storage/app/public storage

# Verify
ls -la storage
```

---

## Troubleshooting

### Issue: 404 on uploaded files

**Cause:** Symlink not created or pointing to wrong location

**Solution:**

```bash
cd /home/u736264619/public_html/public
ln -s ../storage/app/public storage
```

### Issue: 503 Service Unavailable

**Cause:** Symlink created but files don't exist in storage

**Solution:**

1. Check if files exist: `ls storage/app/public/member-photos/`
2. Upload test file to verify upload is working
3. Check file permissions: `chmod 775 storage/app/public -R`

### Issue: Permission denied when uploading

**Cause:** Web server doesn't have write permissions

**Solution:**

```bash
chmod -R 775 storage
chown -R u736264619:u736264619 storage
```

### Issue: Symlink function disabled (shared hosting)

**Cause:** PHP `symlink()` function disabled by hosting provider

**Solution:** Use shell command `ln -s` instead of `php artisan storage:link`

---

## Fallback Storage Routes

If symlink cannot be created, the system has fallback routes (defined in `routes/web.php`):

```php
Route::get('/storage/member-photos/{filename}', [StorageController::class, 'memberPhoto']);
Route::get('/storage/{path}', [StorageController::class, 'serve'])->where('path', '.*');
```

These routes serve files directly through Laravel when symlink is unavailable.

---

## Best Practices

1. **Always use the `public` disk** for publicly accessible files
2. **Use consistent naming conventions** for uploaded files
3. **Validate file types** before upload
4. **Limit file sizes** to prevent storage issues
5. **Clean up old files** when records are deleted
6. **Back up storage folder** regularly
7. **Test symlink** after deployment
8. **Monitor storage space** usage

---

## Storage Space Monitoring

```bash
# Check storage size
du -sh storage/app/public/*

# Find large files
find storage/app/public -type f -size +5M -exec ls -lh {} \;

# Count files per folder
find storage/app/public -type f | wc -l
```
